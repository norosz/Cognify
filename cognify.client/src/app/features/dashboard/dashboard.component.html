<div class="dashboard-header">
    <div>
        <h1>My Modules</h1>
        <p class="text-secondary">Your learning workspace overview.</p>
    </div>
    <button mat-raised-button color="primary" (click)="openCreateModuleDialog()">
        <mat-icon>add</mat-icon>
        Create Module
    </button>
</div>

<div class="insights-grid">
    <mat-card class="insight-card cognify-glass-card">
        <mat-card-header>
            <mat-card-title>Review Queue</mat-card-title>
            <mat-card-subtitle>Topics due for review</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
            @if (isKnowledgeLoading()) {
            <div class="loading-inline">
                <mat-spinner diameter="28"></mat-spinner>
            </div>
            } @else {
            @if (reviewQueue().length === 0) {
            <div class="empty-inline">
                <mat-icon>event_available</mat-icon>
                <p>No topics are due right now.</p>
            </div>
            } @else {
            <ul class="topic-list">
                @for (item of reviewQueue(); track item.topic) {
                <li>
                    <span class="topic-name">{{ item.topic }}</span>
                    <span class="topic-meta">Due {{ item.nextReviewAt ? (item.nextReviewAt | date: 'MMM d') : 'soon' }}</span>
                </li>
                }
            </ul>
            }
            }
        </mat-card-content>
        <mat-card-actions align="end">
            <button mat-stroked-button color="primary" (click)="generateReviewQuiz()"
                [disabled]="isGenerating() || isKnowledgeLoading() || reviewQueue().length === 0 || !hasNotesForAdaptiveQuizzes()">
                Generate Review Quiz
            </button>
        </mat-card-actions>
    </mat-card>

    <mat-card class="insight-card cognify-glass-card">
        <mat-card-header>
            <mat-card-title>Weak Topics</mat-card-title>
            <mat-card-subtitle>Highest forgetting risk</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
            @if (isKnowledgeLoading()) {
            <div class="loading-inline">
                <mat-spinner diameter="28"></mat-spinner>
            </div>
            } @else {
            @if (weakTopics().length === 0) {
            <div class="empty-inline">
                <mat-icon>auto_awesome</mat-icon>
                <p>No weak topics yet.</p>
            </div>
            } @else {
            <ul class="topic-list">
                @for (item of weakTopics(); track item.topic) {
                <li>
                    <span class="topic-name">{{ item.topic }}</span>
                    <span class="topic-meta">Risk {{ (item.forgettingRisk * 100) | number: '1.0-0' }}%</span>
                </li>
                }
            </ul>
            }
            }
        </mat-card-content>
        <mat-card-actions align="end">
            <button mat-stroked-button color="primary" (click)="generateWeaknessQuiz()"
                [disabled]="isGenerating() || weakTopics().length === 0 || !hasNotesForAdaptiveQuizzes()">
                Generate Weakness Quiz
            </button>
        </mat-card-actions>
    </mat-card>
    </div>

    <div class="modules-grid">
        @for (module of modules(); track module.id) {
        <mat-card class="module-card cognify-glass-card cursor-pointer" [routerLink]="['/modules', module.id]">
            <mat-card-header>
                <mat-card-title>{{ module.title }}</mat-card-title>
                <mat-card-subtitle>Created {{ module.createdAt | date }}</mat-card-subtitle>
            </mat-card-header>
            <mat-card-content>
                <p>{{ module.description || 'No description provided.' }}</p>

                <p class="module-category" *ngIf="module.categoryLabel">
                    Category: {{ module.categoryLabel }}
                </p>

                <div class="stats-row">
                    <div class="stat-item">
                        <mat-icon>description</mat-icon>
                        <div class="stat-text">
                            <span class="stat-label">Documents</span>
                            <span class="stat-value">{{ module.documentsCount || 0 }}</span>
                        </div>
                    </div>
                    <div class="stat-item">
                        <mat-icon>event_note</mat-icon>
                        <div class="stat-text">
                            <span class="stat-label">Notes</span>
                            <span class="stat-value">{{ module.notesCount || 0 }}</span>
                        </div>
                    </div>
                    <div class="stat-item">
                        <mat-icon>school</mat-icon>
                        <div class="stat-text">
                            <span class="stat-label">Quizzes &amp; Exams</span>
                            <span class="stat-value">{{ module.quizzesCount || 0 }}</span>
                        </div>
                    </div>
                </div>

            </mat-card-content>
            <mat-card-actions align="end">
                <button mat-icon-button [matMenuTriggerFor]="menu" (click)="$event.stopPropagation()">
                    <mat-icon>more_vert</mat-icon>
                </button>
                <mat-menu #menu="matMenu">
                    <button mat-menu-item (click)="openEditModuleDialog($event, module)">
                        <mat-icon>edit</mat-icon> Edit
                    </button>
                    <button mat-menu-item class="delete-item" (click)="deleteModule($event, module.id)">
                        <mat-icon color="warn">delete</mat-icon> Delete
                    </button>
                </mat-menu>
            </mat-card-actions>
        </mat-card>
        } @empty {
        <mat-card class="empty-state cognify-glass-card">
            <mat-card-content class="empty-state-content">
                <mat-icon class="huge-icon">library_books</mat-icon>
                <p>No modules yet. Create your first one!</p>
            </mat-card-content>
        </mat-card>
        }
    </div>