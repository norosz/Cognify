<div class="dashboard-header">
    <h1>My Modules</h1>
    <button mat-raised-button color="primary" (click)="openCreateModuleDialog()">
        <mat-icon>add</mat-icon>
        New Module
    </button>
</div>

<div class="insights-grid">
    <mat-card class="insight-card cognify-glass-card">
        <mat-card-header>
            <mat-card-title>Review Queue</mat-card-title>
            <mat-card-subtitle>Topics due for review</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
            @if (isKnowledgeLoading()) {
            <div class="loading-inline">
                <mat-spinner diameter="28"></mat-spinner>
            </div>
            } @else {
            @if (reviewQueue().length === 0) {
            <div class="empty-inline">
                <mat-icon>event_available</mat-icon>
                <p>No topics are due right now.</p>
            </div>
            } @else {
            <ul class="topic-list">
                @for (item of reviewQueue(); track item.topic) {
                <li>
                    <span class="topic-name">{{ item.topic }}</span>
                    <span class="topic-meta">Risk {{ (item.forgettingRisk * 100) | number: '1.0-0' }}%</span>
                </li>
                }
            </ul>
            }
            }
        </mat-card-content>
        <mat-card-actions align="end">
            <button mat-stroked-button color="primary" (click)="generateReviewQuiz()" [disabled]="isGenerating() || reviewQueue().length === 0">
                Generate Review Quiz
            </button>
        </mat-card-actions>
    </mat-card>

    <mat-card class="insight-card cognify-glass-card">
        <mat-card-header>
            <mat-card-title>Weak Topics</mat-card-title>
            <mat-card-subtitle>Highest forgetting risk</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
            @if (isKnowledgeLoading()) {
            <div class="loading-inline">
                <mat-spinner diameter="28"></mat-spinner>
            </div>
            } @else {
            @if (weakTopics().length === 0) {
            <div class="empty-inline">
                <mat-icon>psychology</mat-icon>
                <p>No knowledge data yet.</p>
            </div>
            } @else {
            <ul class="topic-list">
                @for (item of weakTopics(); track item.id) {
                <li>
                    <span class="topic-name">{{ item.topic }}</span>
                    <span class="topic-meta">Mastery {{ (item.masteryScore * 100) | number: '1.0-0' }}%</span>
                </li>
                }
            </ul>
            }
            }
        </mat-card-content>
        <mat-card-actions align="end">
            <button mat-stroked-button color="primary" (click)="generateWeaknessQuiz()" [disabled]="isGenerating() || weakTopics().length === 0">
                Generate Weakness Quiz
            </button>
        </mat-card-actions>
    </mat-card>

    <mat-card class="insight-card cognify-glass-card">
        <mat-card-header>
            <mat-card-title>Learning Summary</mat-card-title>
            <mat-card-subtitle>Last 30 days</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
            @if (isAnalyticsLoading()) {
            <div class="loading-inline">
                <mat-spinner diameter="28"></mat-spinner>
            </div>
            } @else {
            @if (!analyticsSummary()) {
            <div class="empty-inline">
                <mat-icon>analytics</mat-icon>
                <p>No analytics data yet.</p>
            </div>
            } @else {
            <div class="summary-grid">
                <div class="summary-item">
                    <span class="summary-label">Avg Score</span>
                    <span class="summary-value">{{ analyticsSummary()!.averageScore | number: '1.0-0' }}%</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Correct Rate</span>
                    <span class="summary-value">{{ (analyticsSummary()!.correctRate * 100) | number: '1.0-0' }}%</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Attempts</span>
                    <span class="summary-value">{{ analyticsSummary()!.totalAttempts }}</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Active Topics</span>
                    <span class="summary-value">{{ analyticsSummary()!.activeTopics }}</span>
                </div>
            </div>
            }
            }
        </mat-card-content>
    </mat-card>
</div>

<div class="modules-grid">
    @for (module of modules(); track module.id) {
    <mat-card class="module-card cognify-glass-card cursor-pointer" [routerLink]="['/modules', module.id]">
        <mat-card-header>
            <mat-card-title>{{ module.title }}</mat-card-title>
            <mat-card-subtitle>Created {{ module.createdAt | date }}</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
            <p>{{ module.description || 'No description provided.' }}</p>

            <div class="stats-row">
                <div class="stat-item" matTooltip="Documents">
                    <mat-icon>description</mat-icon>
                    <span>{{ module.documentsCount || 0 }}</span>
                </div>
                <div class="stat-item" matTooltip="Notes">
                    <mat-icon>event_note</mat-icon>
                    <span>{{ module.notesCount || 0 }}</span>
                </div>
                <div class="stat-item" matTooltip="Quizzes">
                    <mat-icon>school</mat-icon>
                    <span>{{ module.quizzesCount || 0 }}</span>
                </div>
            </div>

        </mat-card-content>
        <mat-card-actions align="end" (click)="$event.stopPropagation()">
            <button mat-icon-button [matMenuTriggerFor]="menu">
                <mat-icon>more_vert</mat-icon>
            </button>
            <mat-menu #menu="matMenu">
                <button mat-menu-item (click)="openEditModuleDialog($event, module)">
                    <mat-icon>edit</mat-icon> Edit
                </button>
                <button mat-menu-item class="delete-item" (click)="deleteModule($event, module.id)">
                    <mat-icon color="warn">delete</mat-icon> Delete
                </button>
            </mat-menu>
        </mat-card-actions>
    </mat-card>
    } @empty {
    <mat-card class="empty-state cognify-glass-card">
        <mat-card-content class="empty-state-content">
            <mat-icon class="huge-icon">library_books</mat-icon>
            <p>No modules yet. Create your first one!</p>
        </mat-card-content>
    </mat-card>
    }
</div>

<div class="visualizations-grid">
    <mat-card class="visualization-card cognify-glass-card">
        <mat-card-header>
            <mat-card-title>Knowledge Map</mat-card-title>
            <mat-card-subtitle>Mastery vs. forgetting risk</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
            @if (!analyticsSummary()) {
            <div class="empty-inline">
                <mat-icon>grid_view</mat-icon>
                <p>No topics to visualize yet.</p>
            </div>
            } @else {
            <ul class="knowledge-map">
                @for (topic of analyticsSummary()!.topics; track topic.topic) {
                <li>
                    <div class="knowledge-header">
                        <span class="topic-name">{{ topic.topic }}</span>
                        <span class="topic-meta">Mastery {{ (topic.masteryScore * 100) | number: '1.0-0' }}%</span>
                    </div>
                    <div class="bar-row">
                        <div class="bar mastery" [style.width]="getMasteryWidth(topic.masteryScore)"></div>
                    </div>
                    <div class="bar-row">
                        <div class="bar risk" [style.width]="getRiskWidth(topic.forgettingRisk)"></div>
                    </div>
                </li>
                }
            </ul>
            }
        </mat-card-content>
    </mat-card>

    <mat-card class="visualization-card cognify-glass-card">
        <mat-card-header>
            <mat-card-title>Memory Decay</mat-card-title>
            <mat-card-subtitle>Average quiz score trend</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
            @if (!analyticsSummary()) {
            <div class="empty-inline">
                <mat-icon>show_chart</mat-icon>
                <p>No trend data yet.</p>
            </div>
            } @else {
            <div class="trend-chart">
                @for (point of analyticsSummary()!.trends; track point.date) {
                <div class="trend-bar">
                    <div class="trend-fill" [style.height]="getTrendHeight(point.averageScore)"></div>
                    <span class="trend-label">{{ point.date | date: 'MM/dd' }}</span>
                </div>
                }
            </div>
            }
        </mat-card-content>
    </mat-card>
</div>